process TQAF = {

  # initialize MessageLogger
  include "FWCore/MessageLogger/data/MessageLogger.cfi"
  replace MessageLogger.cerr.threshold = "INFO"
  # return trigger report (including filter efficiencies)
  untracked PSet options = { untracked bool wantSummary = true }

  untracked PSet maxEvents = { untracked int32 input = 100 }


  ### FAMOS ###

  # Random number generator service
  service =  RandomNumberGeneratorService {
    # This is to initialize the random engine of the source
    untracked uint32 sourceSeed = 123456789
    # This is to initialize the random engines of Famos
    PSet moduleSeeds = {
      untracked uint32 VtxSmeared = 123456789
      untracked uint32 famosPileUp = 918273
      untracked uint32 famosSimHits = 13579
      untracked uint32 siTrackerGaussianSmearingRecHits = 24680
      untracked uint32 caloRecHits = 654321
      untracked uint32 paramMuons = 54525
    }
  }

  # Generate ttbar events
  include "FastSimulation/Configuration/data/ttbar.cfi"

  # Famos sequences
  include "FastSimulation/Configuration/data/FamosSequences.cff"
  # If you want to turn on/off pile-up (e.g. default low lumi: 5.0)
  replace famosPileUp.PileUpSimulator.averageNumber = 0
  # You may not want to simulate everything for your study
  replace famosSimHits.SimulateCalorimetry = true
  replace famosSimHits.SimulateTracking = true
  replace famosSimHits.SimulateMuons = true
  # Parametrized magnetic field
  replace VolumeBasedMagneticFieldESProducer.useParametrizedTrackerField = true

  # Tracker MisAlignement 
  # include "FastSimulation/Configuration/data/MisAlignment.cff" 
  # ECAL miscalibration. 
  # include "FastSimulation/Configuration/data/MisCalibration.cff"

  # service = Timing { }
  path pf = { famosWithEverything }

  # GenParticle transition
  include "PhysicsTools/HepMCCandAlgos/data/genParticleCandidates2GenParticles.cfi"

  path pg = { genParticles }

  ### TQAF ###

  # TQAF Layer 1 TopObject production
  include "TopQuarkAnalysis/TopObjectProducers/data/TQAFLayer1.cff"
	  
  # TQAF Layer 2 for the ttbar semi-leptonic final state
  include "TopQuarkAnalysis/TopEventProducers/data/TQAFLayer2_TtSemi.cff"


  ### FAMOS replace statements ###

  // to use famos gsTracks
  replace allLayer1TopJets.trackAssociation.tracksSource = gsWithMaterialTracks
  replace allLayer1TopElectrons.tracksSource = gsWithMaterialTracks
  replace allLayer1TopMuons.tracksSource = gsWithMaterialTracks
  replace egammaElectronTkIsolation.trackProducer=gsWithMaterialTracks
  replace egammaElectronTkNumIsolation.trackProducer=gsWithMaterialTracks
  // to use famos muons
  replace allLayer1TopMETs.muonSource = paramMuons:ParamGlobalMuons
  replace allLayer1TopMuons.muonSource = paramMuons:ParamGlobalMuons
  replace allLayer1TopMuons.trackIsoSource = muParamGlobalIsoDepositGsTk
  replace allLayer1TopMuons.ecalIsoSource  = muParamGlobalIsoDepositCalEcal
  replace allLayer1TopMuons.hcalIsoSource  = muParamGlobalIsoDepositCalHcal
  replace allLayer1TopMuons.hocalIsoSource = famos


  ### Output ###

  path p = {
    tqafLayer1,
    tqafLayer2_TtSemi
  }

  # to only accept events passing the complete path
  block EventSelection = {
    untracked PSet SelectEvents = {
      vstring SelectEvents = { "p" }
    }
  }

  module out = PoolOutputModule {
    untracked string fileName = "TQAFLayer2Output.root"
    using EventSelection
    untracked vstring outputCommands = {
      "drop *",
      "keep edmTriggerResults_TriggerResults_*_*",
      "keep recoJetTags_*_*_*",
      "drop recoJetTags_coneIsolationTauJetTags_*_*",
      "keep recoTracks_gsWithMaterialTracks_*_*",
      "keep *_offlinePrimaryVerticesFromCTFTracks_*_*",
      "keep *_selectedTopElectrons_*_*",
      "keep *_selectedTopMuons_*_*",
      "keep *_selectedTopTaus_*_*",
      "keep *_selectedTopJets_*_*",
      "keep *_selectedTopMETs_*_*",
      "keep *_initSubset_*_*",
      "keep *_decaySubset_*_*",
      "keep *_genEvt_*_*",
      "keep *_solutions_*_*"
    }
    untracked bool verbose = false
  }

  endpath outpath = { out }	

}
