process TQAF = {

  # initialize MessageLogger
  include "FWCore/MessageLogger/data/MessageLogger.cfi"
  replace MessageLogger.cerr.threshold = "WARNING"

  source = PoolSource {
    untracked vstring fileNames = { 'file:famos_aod_output.root' }
  }
  untracked PSet maxEvents = { untracked int32 input = -1 }


  ### TQAF ###

  # perform high level reco tasks
  include "TopQuarkAnalysis/TopObjectProducers/data/TQAFHighLevelReco.cff"

  # build the TopObjects (TopJets, TopMuons, TopElectrons, TopMETs)
  include "TopQuarkAnalysis/TopObjectProducers/data/TopObjectProducers.cff"

  # Construct the MC Generated Ttbar Event
  include "TopQuarkAnalysis/TopEventProducers/data/TtGenEvtProducer.cff"

  # filter a specific decay chain
  include "TopQuarkAnalysis/TopEventProducers/data/TtFullyLeptonicFilter.cfi"

  # apply a kinematic selection on the TopObjects
  include "TopQuarkAnalysis/TopEventProducers/data/TtDilepObjectSelection.cff"

  # TtDilepEvt solutions
  include "TopQuarkAnalysis/TopEventProducers/data/TtDilepEvtSolProducer.cfi"


  ### FAMOS replace statements ###

  // to use gsTracks
  replace jetTracksAssociator.tracks = gsWithMaterialTracks
  replace allLayer1TopBJets.trackAssociation.tracksSource = gsWithMaterialTracks
  replace allLayer1TopLJets.trackAssociation.tracksSource = gsWithMaterialTracks
  replace allLayer1TopElectrons.tracksSource = gsWithMaterialTracks
  // to use Famos muons
  replace allLayer1TopMETs.muonSource = "paramMuons:ParamGlobalMuons"
  replace allLayer1TopMuons.muonSource = "paramMuons:ParamGlobalMuons"	

  ### Output ###

  path p = {
    makeGenEvt,
    ttFullyLeptonicFilter,
    tqafHighLevelReco,
    allTopObjects,
    objectSelection,
    solutions
  }

  # to only accept events passing the complete path
  block EventSelection = {
    untracked PSet SelectEvents = {
      vstring SelectEvents = { "p" }
    }
  }

  module out = PoolOutputModule {
    untracked string fileName = "TQAFLayer2Output_dilep_fast.root"
    using EventSelection
    untracked vstring outputCommands = {
      "drop *",
      "keep CrossingFrame_*_*_*",
      "keep edmTriggerResults_TriggerResults_*_*",
      "keep recoJetTags_*_*_*",
      "keep recoTracks_ctfWithMaterialTracks_*_*",
      "keep *_offlinePrimaryVerticesFromCTFTracks_*_*",
      "keep *_selectedTopBJets_*_*",
      "keep *_selectedTopLJets_*_*",
      "keep *_selectedTopElectrons_*_*",
      "keep *_selectedTopMuons_*_*",
      "keep *_selectedTopMETs_*_*",
#      "keep *_allLayer1TopTaus_*_*",
      "keep *_decaySubset_*_*",
      "keep *_genEvt_*_*",
      "keep *_solutions_*_*"
    }
    untracked bool verbose = false
  }

  endpath outpath = { out }	

}
